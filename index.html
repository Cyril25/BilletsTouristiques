<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collection Billet Touristique</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- STYLE GENERAL --- */
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        #app-content { max-width: 1400px; margin: 0 auto; }
        
        /* En-tête */
        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; 
            background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* --- FILTRES (inchangé) --- */
        .filters-container {
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 140px; }
        .filter-group label { font-size: 0.8em; color: #666; margin-bottom: 5px; font-weight: bold; }
        select, input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #search-input { min-width: 250px; flex-grow: 2; }

        /* --- LE STYLE DE VOS VIGNETTES (DESIGN RETROUVÉ) --- */
        #cards-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 25px;
        }

        .global-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
        }

        .header-container {
            position: relative;
            height: 200px; /* Ajustez la hauteur de l'image ici */
            color: white; /* Par défaut blanc si pas surchargé */
        }

        .image-bg {
            width: 100%; height: 100%;
            background-size: cover !important;
            background-position: center !important;
        }

        .category {
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            font-weight: bold;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 0.8em;
            color: white; /* Force le texte blanc */
        }

        .header-info {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        .header-info h1 {
            margin: 0; font-size: 1.4em; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); color: white;
        }

        .content { padding: 15px; flex-grow: 1; font-size: 0.9em; line-height: 1.5; }
        
        .description { margin-bottom: 15px; font-weight: 500; color: #444; }
        
        /* Les classes pour cacher les éléments si le CSV dit "hidden" */
        .hidden { display: none !important; }

        .more {
            border-top: 1px solid #eee;
            padding: 8px;
            background: #f9f9f9;
            font-size: 0.85em;
        }

        table.dates { width: 100%; font-size: 0.9em; }
        table.dates td { padding: 2px; }
        
        .action-icons img {
            transition: transform 0.2s;
            vertical-align: middle;
        }
        .action-icons img:hover { transform: scale(1.2); }

        #btn-load-more {
             background-color: #4285F4; color: white; border: none; padding: 12px 30px; 
             font-size: 16px; border-radius: 50px; cursor: pointer; display: none;
        }
    </style>
</head>
<body>

    <div id="app-content">
        <header>
            <div>
                <span style="font-weight:bold; font-size:1.2em;">Annuaire Billets</span>
                <span id="counter" style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.8em; margin-left:10px;">Chargement...</span>
            </div>
        </header>

        <div class="filters-container">
            <div class="filter-group" style="flex-grow: 2;">
                <label>Recherche</label>
                <input type="text" id="search-input" placeholder="Ville, Nom..." onkeyup="applyFilters()">
            </div>
            <div class="filter-group"><label>Catégorie</label><select id="sel-cat" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Pays</label><select id="sel-pays" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Millésime</label><select id="sel-year" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Thème</label><select id="sel-theme" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Collecteur</label><select id="sel-coll" onchange="applyFilters()"><option value="">Tout</option></select></div>
        </div>

        <div id="cards-grid">
            <p style="text-align:center; padding:40px;">Chargement...</p>
        </div>

        <div style="text-align:center; margin: 40px 0;">
            <button id="btn-load-more" onclick="showMore()">Voir la suite</button>
        </div>
    </div>

    <script>
        // ============================================================
        // ⚠️ REMETTRE VOTRE URL APPS SCRIPT ICI ⚠️
        // ============================================================
        const scriptUrl = "https://script.google.com/macros/s/AKfycbxPf3mHI7wEV4ymuMuovDO1CuQpkGtsIILp6AtEQlqURi-2ckTS9h0vbz_GZCNMi6ZK/exec"; 

        let allData = [];
        let currentData = [];
        let displayedCount = 0;
        const BATCH_SIZE = 50;
        let isFullLoaded = false;

        document.addEventListener('DOMContentLoaded', () => { fetchFastThenSlow(); });

        function fetchFastThenSlow() {
            const counter = document.getElementById('counter');
            fetch(scriptUrl + "?limit=50")
                .then(res => res.json())
                .then(data => {
                    if (!isFullLoaded) {
                        allData = data;
                        populateFilters(); applyFilters(false);
                        counter.innerText = "Chargement suite...";
                        counter.style.backgroundColor = "#fff3cd";
                    }
                })
                .then(() => { return fetch(scriptUrl); })
                .then(res => res.json())
                .then(fullData => {
                    allData = fullData;
                    isFullLoaded = true;
                    populateFilters(); applyFilters(true);
                    counter.innerText = allData.length + " billets";
                    counter.style.backgroundColor = "#d4edda";
                });
        }

        function populateFilters() {
            const maps = [
                { id: 'sel-cat', key: 'Categorie' },
                { id: 'sel-pays', key: 'Pays' },
                { id: 'sel-year', key: 'Millesime' },
                { id: 'sel-theme', key: 'Theme' },
                { id: 'sel-coll', key: 'Collecteur' }
            ];
            maps.forEach(m => {
                const select = document.getElementById(m.id);
                const currentVal = select.value;
                let h = '<option value="">Tout</option>';
                [...new Set(allData.map(item => item[m.key]).filter(v => v))].sort().forEach(val => {
                    h += `<option value="${val}" ${val===currentVal?'selected':''}>${val}</option>`;
                });
                select.innerHTML = h;
            });
        }

        function applyFilters(silent = false) {
            const s = document.getElementById('search-input').value.toLowerCase();
            const fCat = document.getElementById('sel-cat').value;
            const fPays = document.getElementById('sel-pays').value;
            const fYear = document.getElementById('sel-year').value;
            const fTheme = document.getElementById('sel-theme').value;
            const fColl = document.getElementById('sel-coll').value;

            currentData = allData.filter(item => {
                const txt = !s || (item.NomBillet && item.NomBillet.toLowerCase().includes(s)) ||
                                  (item.Ville && item.Ville.toLowerCase().includes(s)) ||
                                  (item.Recherche && item.Recherche.toLowerCase().includes(s));
                return txt && (!fCat || item.Categorie === fCat) &&
                       (!fPays || item.Pays === fPays) && (!fYear || item.Millesime == fYear) &&
                       (!fTheme || item.Theme === fTheme) && (!fColl || item.Collecteur === fColl);
            });

            if (!silent) {
                document.getElementById('cards-grid').innerHTML = ""; 
                displayedCount = 0; 
                showMore();
            } else {
                updateLoadMoreButton();
            }
            if(isFullLoaded) document.getElementById('counter').innerText = currentData.length + " billets";
        }

        function showMore() {
            const grid = document.getElementById('cards-grid');
            const batch = currentData.slice(displayedCount, displayedCount + BATCH_SIZE);
            
            if(batch.length === 0 && displayedCount === 0) {
                grid.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>Aucun résultat.</p>";
                updateLoadMoreButton(); return;
            }

            let html = "";
            batch.forEach(item => {
                // Construction des liens dynamiques (ou vide si pas de lien)
                const imgUrl = item.ImageId ? `https://drive.google.com/thumbnail?id=${item.ImageId}` : '';
                const downloadLink = item.ImageId ? `https://drive.usercontent.google.com/download?id=${item.ImageId}` : '#';
                const couleur = item.Couleur || '#ccc';

                // Reconstitution exacte de votre vignette
                html += `
                <div class="global-container">
                    <div class="header-container" style="color:${couleur};">
                         <div class="image-bg" style="background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%), url(${imgUrl}) no-repeat; "></div>
                         <div class="category" style="border:1px solid ${couleur};">${item.Categorie}</div>
                         <div class="header-info">
                             <h1>${item.Ville || ''}</h1>
                         </div>
                    </div>
                    
                    <div class="content">
                        <div class="description">
                            ${item.Dep || ''} ${item.Reference || ''} ${item.Millesime || ''}-${item.Version || ''}<br />
                            ${item.Cp || ''} ${item.Ville || ''}<br />
                            ${item.NomBillet || ''}
                        </div>
                        
                        <div class="${item.CollecteCache || ''}">
                            Par ${item.Collecteur || '?'} au prix de ${item.Prix || '?'} euros ${item.FDP || ''} ${item.FDP_Com || ''}
                            <br><br>
                            <i>${item.InfoPaiement || ''}</i>
                        </div>
                        
                        <div class="${item.ComCache || ''}">
                            Commentaire : ${item.Commentaire || ''}
                        </div>
                    </div>

                    <div class="more">
                        <center>
                            <table class="dates">
                                <tr><td>Pré Collecte :</td><td><b>${item.DatePre || ''}</b></td></tr>
                                <tr><td>Collecte :</td><td><b>${item.DateColl || ''}</b></td></tr>
                                <tr><td>Terminé :</td><td><b>${item.DateFin || ''}</b></td></tr>
                            </table>
                        </center>
                    </div>

                    <div class="more">
                        <center>${item.CompteurBT || ''}</center>
                    </div>

                    <div class="more action-icons">
                        <center>
                            ${item.Sondage ? `<a href="${item.Sondage}" target="_blank"><img style="margin-left: 10px" height="20px;" src="https://drive.google.com/thumbnail?id=1tho3wrh3YJMcZqryJrAHbury01qt-5sY" title="Sondage" /></a>` : ''}
                            ${item.LinkSheet ? `<a href="${item.LinkSheet}" target="_blank"><img style="margin-left: 10px" height="20px;" src="https://drive.google.com/thumbnail?id=1SX9hhBp2Y8eQTJYFaKMMpGQfzZKRToOt" title="Sheet" /></a>` : ''}
                            ${item.LinkFB ? `<a href="${item.LinkFB}" target="_blank"><img style="margin-left: 10px" height="20px;" src="https://drive.google.com/thumbnail?id=1qheBfrQFEnoCUg1YqMAS2wjbxi9KBqb6" title="Facebook" /></a>` : ''}
                            ${item.ImageId ? `<a href="${downloadLink}" target="_blank"><img style="margin-left: 10px" height="20px;" src="https://drive.google.com/thumbnail?id=12S9iSApngkIR_gfDiOJczJiMbwE4-zbZ" title="Télécharger Image" /></a>` : ''}
                            &nbsp;&nbsp;&nbsp;<span style='font-size:10px; color:#999;'>(n°${item.Timestamp || ''})</span>
                        </center>
                    </div>
                </div>`;
            });

            grid.insertAdjacentHTML('beforeend', html);
            displayedCount += batch.length;
            updateLoadMoreButton();
        }

        function updateLoadMoreButton() {
            const btn = document.getElementById('btn-load-more');
            if (displayedCount < currentData.length) {
                btn.style.display = 'inline-block';
                btn.innerText = `Voir la suite (${currentData.length - displayedCount})`;
            } else {
                btn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
