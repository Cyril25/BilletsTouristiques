<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collection Billet Touristique</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- STYLE GLOBAL --- */
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        #app-content { max-width: 1400px; margin: 0 auto; }
        
        /* En-tête */
        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; 
            background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* --- FILTRES --- */
        .filters-container {
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 140px; }
        .filter-group label { font-size: 0.8em; color: #666; margin-bottom: 5px; font-weight: bold; }
        select, input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #search-input { min-width: 250px; flex-grow: 2; }

        /* --- GRILLE --- */
        #cards-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 25px;
        }

        /* --- CARTE (VIGNETTE) --- */
        .global-container {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s;
        }
        .global-container:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }

        .header-container {
            position: relative;
            height: 200px;
            color: white;
        }

        .image-bg {
            width: 100%; height: 100%;
            background-size: cover !important;
            background-position: center !important;
        }

        /* Badge Catégorie (Plein) */
        .category {
            position: absolute;
            top: 10px; right: 10px;
            padding: 5px 12px;
            font-weight: bold;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .header-info {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        
        .header-info h1 {
            margin: 0; font-size: 1.4em; text-shadow: 1px 1px 3px rgba(0,0,0,0.9); color: white;
            display: inline-block;
            padding-bottom: 3px; /* Espace pour le soulignement */
        }

        .content { padding: 15px; flex-grow: 1; font-size: 0.9em; line-height: 1.5; }
        .description { margin-bottom: 15px; font-weight: 500; color: #444; }
        
        /* Classe pour cacher les éléments (via CSV hidden) */
        .hidden { display: none !important; }

        .more {
            border-top: 1px solid #eee;
            padding: 8px;
            background: #fafafa;
            font-size: 0.85em;
        }

        table.dates { width: 100%; font-size: 0.9em; color: #555; }
        table.dates td { padding: 2px; }
        
        /* --- ICONES MODERNES --- */
        .action-icons {
            display: flex; justify-content: center; gap: 20px; padding: 10px 0;
        }
        .icon-btn {
            text-decoration: none; font-size: 22px; transition: transform 0.2s, opacity 0.2s; opacity: 0.8;
        }
        .icon-btn:hover { transform: scale(1.2); opacity: 1; }

        /* Couleurs Officielles */
        .ico-form { color: #7248B9; }   /* Violet Google Forms */
        .ico-sheet { color: #21A366; }  /* Vert Google Sheets */
        .ico-fb    { color: #1877F2; }  /* Bleu Facebook */
        .ico-dl    { color: #5f6368; }  /* Gris Download */

        /* Bouton Voir Plus */
        #btn-load-more {
             background-color: #4285F4; color: white; border: none; padding: 12px 30px; 
             font-size: 16px; border-radius: 50px; cursor: pointer; display: none;
             box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px;
        }
        #btn-load-more:hover { background-color: #3367d6; }
    </style>
</head>
<body>

    <div id="app-content">
        <header>
            <div>
                <span style="font-weight:bold; font-size:1.2em;">Annuaire Billets</span>
                <span id="counter" style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.8em; margin-left:10px;">Chargement...</span>
            </div>
        </header>

        <div class="filters-container">
            <div class="filter-group" style="flex-grow: 2;">
                <label>Recherche</label>
                <input type="text" id="search-input" placeholder="Ville, Nom, Réf..." onkeyup="applyFilters()">
            </div>
            <div class="filter-group"><label>Catégorie</label><select id="sel-cat" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Pays</label><select id="sel-pays" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Millésime</label><select id="sel-year" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Thème</label><select id="sel-theme" onchange="applyFilters()"><option value="">Tout</option></select></div>
            <div class="filter-group"><label>Collecteur</label><select id="sel-coll" onchange="applyFilters()"><option value="">Tout</option></select></div>
        </div>

        <div id="cards-grid">
            <p style="text-align:center; padding:40px; color:#666; font-style:italic;">Chargement de la collection...</p>
        </div>

        <div style="text-align:center; margin: 40px 0;">
            <button id="btn-load-more" onclick="showMore()">Voir la suite</button>
        </div>
    </div>

    <script>
        // ============================================================
        // ⚠️ REMPLACEZ LES POINTS PAR VOTRE URL APPS SCRIPT ICI ⚠️
        // ============================================================
        const scriptUrl = "https://script.google.com/macros/s/AKfycbzlv-bgfLieBK29R07VN8R2a6Qv1UQmznzSZ_sIYcvgsKkSGz2d-kOXoLCS8zqlrjWp/exec"; 

        let allData = [];
        let currentData = [];
        let displayedCount = 0;
        const BATCH_SIZE = 50;
        let isFullLoaded = false;

        document.addEventListener('DOMContentLoaded', () => { fetchFastThenSlow(); });

        // --- CHARGEMENT INTELLIGENT ---
        function fetchFastThenSlow() {
            const counter = document.getElementById('counter');
            // 1. Appel rapide (50 derniers)
            fetch(scriptUrl + "?limit=50")
                .then(res => res.json())
                .then(data => {
                    if (!isFullLoaded) {
                        allData = data;
                        populateFilters(); applyFilters(false);
                        counter.innerText = "Chargement suite...";
                        counter.style.backgroundColor = "#fff3cd";
                    }
                })
                .then(() => { 
                    // 2. Appel complet (Arrière-plan)
                    return fetch(scriptUrl); 
                })
                .then(res => res.json())
                .then(fullData => {
                    allData = fullData;
                    isFullLoaded = true;
                    populateFilters(); applyFilters(true); // Mode silencieux
                    counter.innerText = allData.length + " billets";
                    counter.style.backgroundColor = "#d4edda";
                })
                .catch(err => console.error(err));
        }

        // --- GESTION DES FILTRES ---
        function populateFilters() {
            const maps = [
                { id: 'sel-cat', key: 'Categorie' },
                { id: 'sel-pays', key: 'Pays' },
                { id: 'sel-year', key: 'Millesime' },
                { id: 'sel-theme', key: 'Theme' },
                { id: 'sel-coll', key: 'Collecteur' }
            ];
            maps.forEach(m => {
                const select = document.getElementById(m.id);
                const currentVal = select.value;
                let h = '<option value="">Tout</option>';
                [...new Set(allData.map(item => item[m.key]).filter(v => v))].sort().forEach(val => {
                    h += `<option value="${val}" ${val===currentVal?'selected':''}>${val}</option>`;
                });
                select.innerHTML = h;
            });
        }

        // --- MOTEUR DE RECHERCHE ---
        function applyFilters(silent = false) {
            const s = document.getElementById('search-input').value.toLowerCase();
            const fCat = document.getElementById('sel-cat').value;
            const fPays = document.getElementById('sel-pays').value;
            const fYear = document.getElementById('sel-year').value;
            const fTheme = document.getElementById('sel-theme').value;
            const fColl = document.getElementById('sel-coll').value;

            currentData = allData.filter(item => {
                const txt = !s || (item.NomBillet && item.NomBillet.toLowerCase().includes(s)) ||
                                  (item.Ville && item.Ville.toLowerCase().includes(s)) ||
                                  (item.Recherche && item.Recherche.toLowerCase().includes(s));
                return txt && (!fCat || item.Categorie === fCat) &&
                       (!fPays || item.Pays === fPays) && (!fYear || item.Millesime == fYear) &&
                       (!fTheme || item.Theme === fTheme) && (!fColl || item.Collecteur === fColl);
            });

            if (!silent) {
                document.getElementById('cards-grid').innerHTML = ""; 
                displayedCount = 0; 
                showMore();
            } else {
                updateLoadMoreButton();
            }
            if(isFullLoaded) document.getElementById('counter').innerText = currentData.length + " billets";
        }

        // --- AFFICHAGE (RENDU HTML) ---
        function showMore() {
            const grid = document.getElementById('cards-grid');
            const batch = currentData.slice(displayedCount, displayedCount + BATCH_SIZE);
            
            if(batch.length === 0 && displayedCount === 0) {
                grid.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>Aucun résultat.</p>";
                updateLoadMoreButton(); return;
            }

            let html = "";
            batch.forEach(item => {
                // Image HD (w800)
                const imgUrl = item.ImageId ? `https://drive.google.com/thumbnail?id=${item.ImageId}&sz=w800` : '';
                const downloadLink = item.ImageId ? `https://drive.usercontent.google.com/download?id=${item.ImageId}` : '#';
                
                // Couleur ou Gris par défaut
                const couleur = item.Couleur || '#666'; 

                html += `
                <div class="global-container" style="border-top: 8px solid ${couleur};">
                    
                    <div class="header-container">
                         <div class="image-bg" style="background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.6) 100%), url(${imgUrl}) no-repeat; "></div>
                         
                         <div class="category" style="background-color: ${couleur}; color: white;">
                            ${item.Categorie}
                         </div>
                         
                         <div class="header-info">
                             <h1 style="border-bottom: 3px solid ${couleur};">
                                ${item.Ville || ''}
                             </h1>
                         </div>
                    </div>
                    
                    <div class="content">
                        <div class="description">
                            ${item.Dep || ''} ${item.Reference || ''} ${item.Millesime || ''}-${item.Version || ''}<br />
                            ${item.Cp || ''} ${item.Ville || ''}<br />
                            ${item.NomBillet || ''}
                        </div>
                        
                        <div class="${item.CollecteCache || ''}">
                            Par ${item.Collecteur || '?'} au prix de ${item.Prix || '?'} euros ${item.FDP || ''} ${item.FDP_Com || ''}
                            <br><br>
                            <i>${item.InfoPaiement || ''}</i>
                        </div>
                        
                        <div class="${item.ComCache || ''}">
                            Commentaire : ${item.Commentaire || ''}
                        </div>
                    </div>

                    <div class="more">
                        <center>
                            <table class="dates">
                                <tr><td>Pré Collecte :</td><td><b>${item.DatePre || ''}</b></td></tr>
                                <tr><td>Collecte :</td><td><b>${item.DateColl || ''}</b></td></tr>
                                <tr><td>Terminé :</td><td><b>${item.DateFin || ''}</b></td></tr>
                            </table>
                        </center>
                    </div>

                    <div class="more">
                        <center>${item.CompteurBT || ''}</center>
                    </div>

                    <div class="more action-icons">
                        ${item.Sondage ? `
                            <a href="${item.Sondage}" target="_blank" class="icon-btn ico-form" title="Répondre au sondage">
                                <i class="fa-solid fa-clipboard-question"></i>
                            </a>` : ''}

                        ${item.LinkSheet ? `
                            <a href="${item.LinkSheet}" target="_blank" class="icon-btn ico-sheet" title="Voir le fichier Excel">
                                <i class="fa-solid fa-file-csv"></i>
                            </a>` : ''}

                        ${item.LinkFB ? `
                            <a href="${item.LinkFB}" target="_blank" class="icon-btn ico-fb" title="Voir sur Facebook">
                                <i class="fa-brands fa-facebook"></i>
                            </a>` : ''}

                        ${item.ImageId ? `
                            <a href="${downloadLink}" target="_blank" class="icon-btn ico-dl" title="Télécharger l'image HD">
                                <i class="fa-solid fa-download"></i>
                            </a>` : ''}
                            
                         <span style='font-size:10px; color:#ccc; align-self:center;'>(n°${item.Timestamp || ''})</span>
                    </div>
                </div>`;
            });

            grid.insertAdjacentHTML('beforeend', html);
            displayedCount += batch.length;
            updateLoadMoreButton();
        }

        function updateLoadMoreButton() {
            const btn = document.getElementById('btn-load-more');
            if (displayedCount < currentData.length) {
                btn.style.display = 'inline-block';
                btn.innerText = `Voir la suite (${currentData.length - displayedCount})`;
            } else {
                btn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
